"""
Story Content ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–æ–≤ –¥–ª—è —Å—Ç–æ—Ä–∏—Å –±–æ—Ç-–∞–∫–∫–∞—É–Ω—Ç–æ–≤.

–®–∞–±–ª–æ–Ω—ã + AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º.
"""

import random
from typing import Optional

from loguru import logger


# –®–∞–±–ª–æ–Ω—ã —Å—Ç–æ—Ä–∏—Å –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º (fallback –µ—Å–ª–∏ AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
STORY_TEMPLATES = {
    "zozh": [
        "–£—Ç—Ä–µ–Ω–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–¥–µ–ª–∞–Ω–∞ ‚úÖ –ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è —Ç–æ–∂–µ?",
        "–ó–∞–≤—Ç—Ä–∞–∫: 40–≥ –±–µ–ª–∫–∞ + –∫–ª–µ—Ç—á–∞—Ç–∫–∞ + –∫–æ—Ñ–µ. –•–æ—Ä–æ—à–µ–µ —É—Ç—Ä–æ ü•ë",
        "–ù–µ–¥–µ–ª—è –±–µ–∑ —Å–∞—Ö–∞—Ä–∞. –≠–Ω–µ—Ä–≥–∏—è —Ä–µ–∞–ª—å–Ω–æ –¥—Ä—É–≥–∞—è",
        "–ö—Ç–æ-–Ω–∏–±—É–¥—å —Å—á–∏—Ç–∞–µ—Ç –ö–ë–ñ–£ –∏–ª–∏ —è –æ–¥–∏–Ω —Ç–∞–∫–æ–π? üòÖ",
        "DrainEffect –ø–µ—Ä–µ–¥ –∑–∞–≤—Ç—Ä–∞–∫–æ–º ‚Äî —É–∂–µ –ø—Ä–∏–≤—ã—á–∫–∞ üíß",
        "–°–µ–≥–æ–¥–Ω—è –≤ –∑–∞–ª–µ –Ω–æ–≥–∏. –ú–æ–ª–∏—Ç–µ—Å—å –∑–∞ –º–µ–Ω—è",
        "–í–∏—Ç–∞–º–∏–Ω D3 ‚Äî –ª—É—á—à–µ–µ —á—Ç–æ —è —Å–¥–µ–ª–∞–ª —ç—Ç–æ–π –∑–∏–º–æ–π",
        "–ö–æ–∫—Ç–µ–π–ª—å 186‚ÇΩ vs –∑–∞–≤—Ç—Ä–∞–∫ –≤ –∫–∞—Ñ–µ 500‚ÇΩ. –í—ã–±–æ—Ä –æ—á–µ–≤–∏–¥–µ–Ω",
    ],
    "mama": [
        "–£—Ç—Ä–æ —Å –¥–µ—Ç—å–º–∏ ‚Äî —ç—Ç–æ —Å–ø–æ—Ä—Ç üåÖ",
        "–ù–∞—à–ª–∞ 10 –º–∏–Ω—É—Ç –Ω–∞ —Å–µ–±—è. –≠—Ç–æ –ø–æ–±–µ–¥–∞",
        "–≠–Ω–µ—Ä–≥–∏–∏ —Ö–≤–∞—Ç–∏–ª–æ –¥–æ –≤–µ—á–µ—Ä–∞. –°–µ–∫—Ä–µ—Ç? –ó–∞–≤—Ç—Ä–∞–∫",
        "–î–µ—Ç–∏ –Ω–∞–∫–æ–Ω–µ—Ü —É—Å–Ω—É–ª–∏. –ú–∞–º—ã –ø–æ–π–º—É—Ç üò¥",
        "–í–∏—Ç–∞–º–∏–Ω—ã –¥–ª—è –≤—Å–µ–π —Å–µ–º—å–∏ ‚Äî –ø—Ä–∏–≤—ã—á–∫–∞ –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–µ",
        "–ö–æ–≥–¥–∞ –Ω–∞—à–ª–∞ —Ç–æ —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –ø–æ–º–æ–≥–∞–µ—Ç —Å —É—Å—Ç–∞–ª–æ—Å—Ç—å—é üå∏",
        "–£—Ç—Ä–µ–Ω–Ω–∏–π —Ä–∏—Ç—É–∞–ª –∑–∞ 5 –º–∏–Ω—É—Ç. –ú–µ–Ω—è–µ—Ç –≤–µ—Å—å –¥–µ–Ω—å",
        "–°–æ–≤–º–µ—â–∞—Ç—å –¥–µ—Ç–µ–π –∏ —Å–≤–æ–∏ –¥–µ–ª–∞ ‚Äî –º–æ–∂–Ω–æ. –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ",
    ],
    "business": [
        "–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞ –Ω–µ–¥–µ–ª—é: +3 –Ω–æ–≤—ã—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–∞ üìà",
        "–î–æ—Ö–æ–¥ –∏–∑ –¥–æ–º–∞ ‚Äî –Ω–µ –º–∏—Ñ. –¢—Ä–µ—Ç–∏–π –º–µ—Å—è—Ü –ø–æ–¥—Ä—è–¥",
        "–ú—ã—Å–ª—å –¥–Ω—è: –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è > –º–æ—Ç–∏–≤–∞—Ü–∏—è",
        "–£—Ç—Ä–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ü–∏—Ñ—Ä. –ü—Ä–∏–≤—ã—á–∫–∞ üíº",
        "–ö—Ç–æ —Å–∫–∞–∑–∞–ª —á—Ç–æ –Ω—É–∂–µ–Ω –æ—Ñ–∏—Å? üè†",
        "–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ ‚Äî —ç—Ç–æ –Ω–µ –ø–∞—Å—Å–∏–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞. –°–Ω–∞—á–∞–ª–∞ –ø–∞—à–µ—à—å",
        "–°–µ–≥–æ–¥–Ω—è –∑–∞–∫—Ä—ã–ª —Ü–µ–ª—å –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º. –ù–∞ 3 –¥–Ω—è —Ä–∞–Ω—å—à–µ",
        "–ö–æ–º–∞–Ω–¥–∞ —Ä–∞—Å—Ç—ë—Ç. –°–∫–æ—Ä–æ –Ω—É–∂–µ–Ω –±—É–¥–µ—Ç –≤—Ç–æ—Ä–æ–π —á–∞—Ç üí™",
    ],
    "student": [
        "–ß—Ç–æ –∏–∑—É—á–∞–ª —Å–µ–≥–æ–¥–Ω—è: –Ω–µ–π—Ä–æ–Ω–∫–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è üìö",
        "AI —Ñ–∞–∫—Ç –¥–Ω—è: ChatGPT –≤—ã–≥–æ—Ä–∞–µ—Ç, Claude –Ω–µ—Ç ü§ñ",
        "–ö–æ–≥–¥–∞ —É—á—ë–±–∞ = –±—É–¥—É—â–∏–π –¥–æ—Ö–æ–¥. –ú–æ—Ç–∏–≤–∞—Ü–∏—è –¥—Ä—É–≥–∞—è",
        "–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞ –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –º–µ—à–∞–µ—Ç —É—á—ë–±–µ ‚Äî —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚úÖ",
        "–ü—Ä–æ—á–∏—Ç–∞–ª –ø—Ä–æ Thompson Sampling. –ú–æ–∑–≥ –∫–∏–ø–∏—Ç üß†",
        "–°—Ç—É–¥–µ–Ω—Ç + –¥–æ—Ö–æ–¥ = —Å–≤–æ–±–æ–¥–∞. –ë–µ–∑ '–ø–æ—Ç–æ–º'",
        "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–ª —Ä—É—Ç–∏–Ω—É. –≠–∫–æ–Ω–æ–º–ª—é 2 —á–∞—Å–∞ –≤ –¥–µ–Ω—å",
        "–§–∏–ª–æ—Å–æ—Ñ–∏—è –¥–Ω—è: –ª—É—á—à–µ –¥–µ–ª–∞—Ç—å –Ω–µ–∏–¥–µ–∞–ª—å–Ω–æ —á–µ–º –Ω–µ –¥–µ–ª–∞—Ç—å",
    ],
}

# –ü—Ä–æ–º–ø—Ç –¥–ª—è AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–æ—Ä–∏—Å
STORY_SYSTEM_PROMPT = """–¢—ã ‚Äî {persona_name}. –ü–∏—à–µ—à—å —Ç–µ–∫—Å—Ç –¥–ª—è Telegram-—Å—Ç–æ—Ä–∏—Å.

–°–µ–≥–º–µ–Ω—Ç: {segment}

–ü–†–ê–í–ò–õ–ê:
1. –î–ª–∏–Ω–∞: 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (50-150 —Å–∏–º–≤–æ–ª–æ–≤)
2. –ö–∞–∫ –ø–æ–¥–ø–∏—Å—å –∫ —Ñ–æ—Ç–æ –∏–ª–∏ –º—ã—Å–ª—å –≤—Å–ª—É—Ö
3. –ú–∞–∫—Å–∏–º—É–º 1-2 —ç–º–æ–¥–∑–∏
4. –ù–∏–∫–∞–∫–∏—Ö —Ö–µ—à—Ç–µ–≥–æ–≤
5. –ñ–∏–≤–æ–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Å—Ç–∏–ª—å
6. –ù–µ –Ω–∞—á–∏–Ω–∞–π —Å –≤–æ–ø—Ä–æ—Å–∞

–ü—Ä–∏–º–µ—Ä—ã —Å—Ç–∏–ª—è: –∫–æ—Ä–æ—Ç–∫–∞—è –º—ã—Å–ª—å, –∏—Ç–æ–≥ –¥–Ω—è, –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ, –≤–æ–ø—Ä–æ—Å –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º.
"""


async def generate_story_text(segment: str = "zozh") -> Optional[str]:
    """
    –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è —Å—Ç–æ—Ä–∏—Å.

    –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ—Ç AI, –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ ‚Äî —à–∞–±–ª–æ–Ω.
    """
    # –ü—Ä–æ–±—É–µ–º AI
    text = await _generate_via_ai(segment)
    if text:
        return text

    # Fallback –Ω–∞ —à–∞–±–ª–æ–Ω—ã
    templates = STORY_TEMPLATES.get(segment, STORY_TEMPLATES["zozh"])
    return random.choice(templates)


async def _generate_via_ai(segment: str) -> Optional[str]:
    """–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Deepseek."""
    try:
        from shared.ai_clients.deepseek_client import DeepseekClient
        from shared.config.settings import settings as app_settings

        client = DeepseekClient(api_key=app_settings.DEEPSEEK_API_KEY)

        system = STORY_SYSTEM_PROMPT.format(
            persona_name="–î–∞–Ω–∏–ª",
            segment=segment,
        )

        topics = STORY_TEMPLATES.get(segment, STORY_TEMPLATES["zozh"])
        topic_hint = random.choice(topics)

        response = await client.generate_response(
            system_prompt=system,
            user_message=f"–ù–∞–ø–∏—à–∏ —Å—Ç–æ—Ä–∏—Å –≤ —Å—Ç–∏–ª–µ: \"{topic_hint}\" (–Ω–æ –¥—Ä—É–≥–∏–º–∏ —Å–ª–æ–≤–∞–º–∏)",
            temperature=0.95,
        )

        if response:
            text = response.strip().strip('"').strip("¬´¬ª")
            if len(text) < 200:
                return text

    except ImportError:
        pass
    except Exception as e:
        logger.error(f"AI story generation failed: {e}")

    return None
