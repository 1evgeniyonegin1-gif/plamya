"""
–ü–†–ò–ú–ï–† –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø MediaResponder –≤ –∫—É—Ä–∞—Ç–æ—Ä–µ.

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ –∫—É—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ/–≥–æ–ª–æ—Å–æ–≤—ã–µ
–∏–∑ –±–∞–∑—ã testimonials –≤ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–≠—Ç–æ—Ç –∫–æ–¥ –ù–ï –∑–∞–¥–µ–ø–ª–æ–µ–Ω - —ç—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏.
"""

from aiogram import Router, F
from aiogram.types import Message, FSInputFile
from pathlib import Path

from curator_bot.ai.media_responder import get_media_responder
from curator_bot.ai.chat_engine import CuratorChatEngine

router = Router(name="media_example")


async def handle_message_with_media(message: Message, user, chat_engine: CuratorChatEngine):
    """
    –ü–†–ò–ú–ï–†: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π –º–µ–¥–∏–∞.

    –õ–æ–≥–∏–∫–∞:
    1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–¥–∏–∞
    2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ AI
    3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ–¥–∏–∞ + —Ç–µ–∫—Å—Ç
    """

    media_responder = get_media_responder()

    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–¥–∏–∞
    media_config = media_responder.should_send_media(message.text)

    # 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç
    ai_response = await chat_engine.generate_response(
        user=user,
        user_message=message.text,
        conversation_history=[],  # —É–ø—Ä–æ—â—ë–Ω–Ω–æ
    )

    # 3. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –º–µ–¥–∏–∞ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
    if media_config['should_send']:
        # –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã
        media_files = media_responder.get_media_for_response(
            media_config,
            count=1  # –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º 1 —Ñ–∞–π–ª
        )

        if media_files:
            # –î–æ–±–∞–≤–ª—è–µ–º –≤–≤–æ–¥–Ω—É—é —Ñ—Ä–∞–∑—É –∫ —Ç–µ–∫—Å—Ç—É
            text_with_context = media_responder.format_text_with_media_context(
                ai_response,
                media_config
            )

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
            await message.answer(text_with_context)

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ–¥–∏–∞
            for media_file in media_files:
                file_path = Path(media_file['path'])
                media_type = media_file['type']
                caption = media_file['caption']

                if not file_path.exists():
                    continue

                input_file = FSInputFile(file_path)

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                if media_type == 'photo':
                    await message.answer_photo(
                        photo=input_file,
                        caption=caption
                    )
                elif media_type == 'video':
                    await message.answer_video(
                        video=input_file,
                        caption=caption
                    )
                elif media_type == 'voice':
                    await message.answer_voice(
                        voice=input_file,
                        caption=caption
                    )
                elif media_type == 'video_message':
                    await message.answer_video_note(
                        video_note=input_file
                    )
        else:
            # –ú–µ–¥–∏–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
            await message.answer(ai_response)
    else:
        # –ú–µ–¥–∏–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è - –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç
        await message.answer(ai_response)


# ============================================
# –ü–†–ò–ú–ï–†–´ –î–ò–ê–õ–û–ì–û–í
# ============================================

"""
–ü–†–ò–ú–ï–† 1: –í–æ–ø—Ä–æ—Å –ø—Ä–æ –ø–æ—Ö—É–¥–µ–Ω–∏–µ

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ü–æ–∫–∞–∂–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Ö—É–¥–µ–Ω–∏—è"

–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
1. should_send_media() –≤–µ—Ä–Ω—ë—Ç:
   {
       'should_send': True,
       'media_type': 'photo',
       'category': 'before_after',
       'subcategory': 'weight_loss',
       'keywords': ['–ø–æ—Ö—É–¥–µ–Ω–∏–µ', '—Ä–µ–∑—É–ª—å—Ç–∞—Ç']
   }

2. AI —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç:
   "–ö–æ–Ω–µ—á–Ω–æ! –í–æ—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å Energy Diet –∑–∞ 3 –º–µ—Å—è—Ü–∞..."

3. format_text_with_media_context() –¥–æ–±–∞–≤–∏—Ç:
   "–í–æ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞—à–∏—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤:"

4. –û—Ç–ø—Ä–∞–≤–∏—Ç—Å—è:
   - –¢–µ–∫—Å—Ç: "–ö–æ–Ω–µ—á–Ω–æ! –í–æ—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å Energy Diet –∑–∞ 3 –º–µ—Å—è—Ü–∞...
             –í–æ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞—à–∏—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤:"
   - –§–æ—Ç–æ: [–¥–æ/–ø–æ—Å–ª–µ –ø–æ—Ö—É–¥–µ–Ω–∏—è —Å –ø–æ–¥–ø–∏—Å—å—é]
"""

"""
–ü–†–ò–ú–ï–† 2: –í–æ–ø—Ä–æ—Å –ø—Ä–æ –∫–æ–ª–ª–∞–≥–µ–Ω

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ü–æ–º–æ–≥–∞–µ—Ç –ª–∏ –∫–æ–ª–ª–∞–≥–µ–Ω –¥–ª—è –∫–æ–∂–∏?"

–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
1. should_send_media() –≤–µ—Ä–Ω—ë—Ç:
   {
       'should_send': True,
       'media_type': 'photo',
       'category': 'before_after',
       'subcategory': 'collagen',
       'keywords': ['–∫–æ–ª–ª–∞–≥–µ–Ω', '–∫–æ–∂–∞']
   }

2. AI —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –ø—Ä–æ –∫–æ–ª–ª–∞–≥–µ–Ω

3. –û—Ç–ø—Ä–∞–≤–∏—Ç—Å—è —Ñ–æ—Ç–æ –¥–æ/–ø–æ—Å–ª–µ –∫–æ–ª–ª–∞–≥–µ–Ω–∞ —Å –ø–æ–¥–ø–∏—Å—å—é:
   "üìç –î–û/–ü–û–°–õ–ï –ö–û–õ–õ–ê–ì–ï–ù

   –†–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ 2 –º–µ—Å—è—Ü–∞ –ø—Ä–∏—ë–º–∞. –ö–æ–∂–∞ —Å—Ç–∞–ª–∞ –±–æ–ª–µ–µ —É–ø—Ä—É–≥–æ–π,
   –º–æ—Ä—â–∏–Ω—ã —Ä–∞–∑–≥–ª–∞–¥–∏–ª–∏—Å—å, —Ü–≤–µ—Ç –ª–∏—Ü–∞ –≤—ã—Ä–æ–≤–Ω—è–ª—Å—è.

   ‚Äî –ê–Ω–Ω–∞, 45 –ª–µ—Ç"
"""

"""
–ü–†–ò–ú–ï–† 3: –ó–∞–ø—Ä–æ—Å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –æ—Ç–∑—ã–≤–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–•–æ—á—É –ø–æ—Å–ª—É—à–∞—Ç—å –æ—Ç–∑—ã–≤ –ø–∞—Ä—Ç–Ω—ë—Ä–∞"

–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
1. should_send_media() –≤–µ—Ä–Ω—ë—Ç:
   {
       'should_send': True,
       'media_type': 'voice',
       'category': 'success_stories',
       'subcategory': None,
       'keywords': ['–æ—Ç–∑—ã–≤']
   }

2. AI —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç: "–û—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ—è!"

3. –û—Ç–ø—Ä–∞–≤–∏—Ç—Å—è:
   - –¢–µ–∫—Å—Ç: "–û—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ—è! –ü–æ—Å–ª—É—à–∞–π –æ–ø—ã—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞:"
   - –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–¥–æ 60 —Å–µ–∫—É–Ω–¥)
"""

"""
–ü–†–ò–ú–ï–† 4: –ó–∞–ø—Ä–æ—Å —á–µ–∫–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–°–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å?"

–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
1. should_send_media() –≤–µ—Ä–Ω—ë—Ç:
   {
       'should_send': True,
       'media_type': 'photo',
       'category': 'checks',
       'subcategory': None,
       'keywords': ['–∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å']
   }

2. AI —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –ø—Ä–æ –¥–æ—Ö–æ–¥—ã

3. –û—Ç–ø—Ä–∞–≤–∏—Ç—Å—è:
   - –¢–µ–∫—Å—Ç: "–î–æ—Ö–æ–¥ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏..."
   - –§–æ—Ç–æ: [—Ä–µ–∞–ª—å–Ω—ã–π —á–µ–∫ –ø–∞—Ä—Ç–Ω—ë—Ä–∞]
"""

"""
–ü–†–ò–ú–ï–† 5: –û–±—â–∏–π –≤–æ–ø—Ä–æ—Å –±–µ–∑ –º–µ–¥–∏–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ö–∞–∫ –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å NL?"

–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
1. should_send_media() –≤–µ—Ä–Ω—ë—Ç:
   {
       'should_send': False,
       ...
   }

2. AI —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –ø—Ä–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∏ –ø–µ—Ä–≤—ã–µ —à–∞–≥–∏

3. –û—Ç–ø—Ä–∞–≤–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç (–±–µ–∑ –º–µ–¥–∏–∞)
"""
