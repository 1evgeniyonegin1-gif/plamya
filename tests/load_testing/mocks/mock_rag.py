"""
Mock RAG Engine для нагрузочного тестирования

Эмулирует RAG без pgvector и embeddings:
- Keyword search вместо vector search
- Быстрый поиск без нагрузки на БД
- Реалистичные результаты
"""

from typing import List, Dict, Optional


# Тестовая база знаний (100 документов)
MOCK_KNOWLEDGE_BASE = [
    # Продукты
    {
        "text": "Energy Diet Smart — это сбалансированный коктейль 200 ккал. Содержит 15г белка, 12 витаминов и минералов. Идеально для замены завтрака или перекуса. Вкусы: шоколад, ваниль, клубника, банан.",
        "category": "products",
        "keywords": ["energy diet", "ed smart", "коктейль", "похудеть", "белок", "завтрак"]
    },
    {
        "text": "Greenflash Collagen — гидролизованный коллаген для кожи, волос и суставов. 5000мг в порции. Результат через 30 дней: упругая кожа, крепкие ногти, здоровые суставы. Без вкуса, растворяется в любом напитке.",
        "category": "products",
        "keywords": ["collagen", "коллаген", "greenflash", "кожа", "волосы", "суставы", "beauty"]
    },
    {
        "text": "VLED (Very Low Energy Diet) — программа быстрого снижения веса. 800 ккал в день, 5 приёмов ED Smart. Потеря 5-7 кг за месяц. Подходит при ИМТ > 27. Требует консультации специалиста.",
        "category": "products",
        "keywords": ["vled", "похудеть", "быстро", "программа", "снижение веса", "диета"]
    },
    {
        "text": "Vita Balance — комплекс мультивитаминов и минералов. 12 витаминов, 8 минералов. Покрывает 100% суточной нормы. Для энергии, иммунитета и общего здоровья. 1 таблетка в день.",
        "category": "products",
        "keywords": ["vita balance", "витамины", "минералы", "энергия", "иммунитет", "здоровье"]
    },
    {
        "text": "Pro Protein — изолят сывороточного белка 90%. 25г белка в порции. Для роста мышц и восстановления после тренировок. Вкусы: шоколад, ваниль, клубника. Без сахара.",
        "category": "products",
        "keywords": ["protein", "протеин", "белок", "мышцы", "тренировки", "спорт"]
    },
    {
        "text": "Energy Drink — натуральный энергетик. Кофеин из гуараны, витамины B-группы, таурин. Даёт энергию на 4-5 часов без crash эффекта. Без сахара, 10 ккал. Удобная банка 250мл.",
        "category": "products",
        "keywords": ["energy drink", "энергия", "бодрость", "кофеин", "гуарана", "энергетик"]
    },
    {
        "text": "Beauty Inside — комплекс для красоты изнутри. Коллаген + гиалуроновая кислота + витамины. Улучшает состояние кожи, волос и ногтей. Результат через 2-3 недели.",
        "category": "products",
        "keywords": ["beauty", "красота", "коллаген", "гиалуроновая", "кожа", "волосы"]
    },
    {
        "text": "Immunity Guard — поддержка иммунитета. Витамин C, цинк, эхинацея, бета-глюкан. Укрепляет защитные силы организма. Особенно важно в сезон простуд.",
        "category": "products",
        "keywords": ["immunity", "иммунитет", "защита", "витамин c", "цинк", "здоровье"]
    },
    {
        "text": "Detox Tea — натуральный детокс чай. Зелёный чай, имбирь, лимон, мята. Выводит токсины, ускоряет метаболизм. Приятный вкус, можно пить холодным.",
        "category": "products",
        "keywords": ["detox", "детокс", "чай", "очищение", "метаболизм", "токсины"]
    },
    {
        "text": "Omega-3 Complex — очищенный рыбий жир. 1000мг EPA+DHA в капсуле. Для сердца, мозга и зрения. Без запаха рыбы. 2 капсулы в день.",
        "category": "products",
        "keywords": ["omega", "омега", "рыбий жир", "сердце", "мозг", "здоровье"]
    },

    # Бизнес и маркетинг-план
    {
        "text": "Маркетинг-план NL International включает 6 квалификаций: M1, M2, M3 (менеджер), B1, B2, B3 (бизнес-директор). Каждая квалификация даёт новые бонусы и возможности.",
        "category": "business",
        "keywords": ["маркетинг", "квалификация", "m1", "m2", "m3", "b1", "b2", "b3"]
    },
    {
        "text": "Квалификация M1 (Менеджер-1): личные продажи 500 PV + 1 активный партнёр. Бонус 21%. Средний доход 20-30 тыс руб/мес. Достигается за 1-2 месяца активной работы.",
        "category": "business",
        "keywords": ["m1", "менеджер", "квалификация", "старт", "500 pv", "21%"]
    },
    {
        "text": "Квалификация M2 (Менеджер-2): личные продажи 1000 PV + 2 активных партнёра (M1). Бонус 24%. Средний доход 40-60 тыс руб/мес. Достигается за 2-4 месяца.",
        "category": "business",
        "keywords": ["m2", "менеджер-2", "1000 pv", "24%", "доход"]
    },
    {
        "text": "Квалификация M3 (Менеджер-3): личные продажи 1500 PV + 3 активных партнёра (M2). Бонус 27%. Средний доход 80-120 тыс руб/мес. Это стабильная квалификация.",
        "category": "business",
        "keywords": ["m3", "менеджер-3", "1500 pv", "27%", "стабильность"]
    },
    {
        "text": "Квалификация B1 (Бизнес-директор-1): 2 линии M3 + командный оборот 10 000 PV. Бонус 30%. Средний доход 150-250 тыс руб/мес. Выход на бизнес-уровень.",
        "category": "business",
        "keywords": ["b1", "бизнес-директор", "10000 pv", "30%", "команда"]
    },
    {
        "text": "Квалификация B2 (Бизнес-директор-2): 3 линии M3 + командный оборот 30 000 PV. Бонус 33%. Средний доход 300-500 тыс руб/мес. Серьёзный бизнес.",
        "category": "business",
        "keywords": ["b2", "бизнес-директор-2", "30000 pv", "33%", "серьезный"]
    },
    {
        "text": "Квалификация B3 (Бизнес-директор-3): 4 линии M3 + командный оборот 60 000 PV. Бонус 36%. Средний доход 600 тыс - 1 млн руб/мес. Топ-уровень.",
        "category": "business",
        "keywords": ["b3", "бизнес-директор-3", "60000 pv", "36%", "топ"]
    },
    {
        "text": "PV (Point Value) — условные баллы для расчёта бонусов. 1 PV ≈ 100 рублей. Начисляются за покупку продукции. Чем выше PV, тем выше бонусы.",
        "category": "business",
        "keywords": ["pv", "баллы", "бонусы", "покупка", "расчет"]
    },
    {
        "text": "Активный партнёр — это партнёр с личными покупками минимум 100 PV в месяц. Для роста квалификации нужны активные партнёры в структуре.",
        "category": "business",
        "keywords": ["активный партнер", "100 pv", "структура", "команда"]
    },
    {
        "text": "Бинарная структура: вы строите 2 линии (левую и правую). Бонусы начисляются от слабой линии. Важно развивать обе линии равномерно.",
        "category": "business",
        "keywords": ["бинарная", "структура", "две линии", "левая", "правая"]
    },
    {
        "text": "Быстрый старт-бонус: за регистрацию нового партнёра вы получаете 20% от его первого заказа. Это дополнительный доход в первый месяц.",
        "category": "business",
        "keywords": ["быстрый старт", "бонус", "20%", "первый заказ", "регистрация"]
    },

    # Истории успеха
    {
        "text": "История Марии, 34 года: Похудела на 18 кг за 4 месяца с Energy Diet. Сначала не верила, но решила попробовать. Первый месяц -5 кг, дальше стабильно по 3-4 кг. Сейчас поддерживаю вес уже год!",
        "category": "success_stories",
        "keywords": ["похудела", "18 кг", "energy diet", "результат", "мария"]
    },
    {
        "text": "История Игоря, 28 лет: За полгода с M1 до B1. Бросил офисную работу, начал строить команду. Первые 3 месяца было сложно, но я не сдался. Сейчас команда 50 человек, доход 200 тыс/мес.",
        "category": "success_stories",
        "keywords": ["игорь", "m1", "b1", "команда", "доход", "200 тысяч"]
    },
    {
        "text": "История Елены, 42 года: Начала с продуктов для себя. Коллаген изменил мою кожу! Подруги стали спрашивать — так я стала партнёром. Теперь M2, доход 50 тыс/мес + сама продукция бесплатно.",
        "category": "success_stories",
        "keywords": ["елена", "коллаген", "кожа", "m2", "50 тысяч"]
    },
    {
        "text": "История Дмитрия, 35 лет: Профессиональный спортсмен. Перешёл на Pro Protein и Energy Drink от NL. Качество не хуже зарубежных брендов, а цена ниже. Теперь рекомендую своим клиентам.",
        "category": "success_stories",
        "keywords": ["дмитрий", "спортсмен", "протеин", "энергетик", "качество"]
    },

    # Возражения и ответы
    {
        "text": "Возражение: Это пирамида? Ответ: Нет, NL — это сетевая компания с реальной продукцией. Пирамида — это когда платишь за вступление и нет продукта. У нас продукция высокого качества, сертифицирована.",
        "category": "objections",
        "keywords": ["пирамида", "возражение", "сертификат", "продукция"]
    },
    {
        "text": "Возражение: Дорого! Ответ: Сравни с аптечными аналогами — наши продукты выгоднее по цене/качеству. Плюс партнёрская скидка 20-30%. Плюс можно зарабатывать.",
        "category": "objections",
        "keywords": ["дорого", "цена", "скидка", "выгода"]
    },
    {
        "text": "Возражение: Не умею продавать. Ответ: Никто не умел в начале! У нас обучение, скрипты, поддержка куратора. Первые продажи — это друзьям и знакомым. Потом втянешься.",
        "category": "objections",
        "keywords": ["не умею", "продавать", "обучение", "скрипты"]
    },
    {
        "text": "Возражение: Нет времени. Ответ: Начни с 1-2 часов в день. Многие совмещают с основной работой первые месяцы. Гибкий график — работаешь когда удобно.",
        "category": "objections",
        "keywords": ["нет времени", "график", "совмещать", "гибкость"]
    },

    # Советы по здоровью
    {
        "text": "Совет: Пей 1.5-2 литра воды в день. Вода ускоряет метаболизм, выводит токсины, улучшает кожу. Начинай утро со стакана тёплой воды с лимоном.",
        "category": "health_tips",
        "keywords": ["вода", "метаболизм", "токсины", "кожа", "утро"]
    },
    {
        "text": "Совет: Завтрак — обязателен! Пропуская завтрак, ты замедляешь метаболизм. Идеальный вариант — ED Smart коктейль: быстро, вкусно, сбалансированно.",
        "category": "health_tips",
        "keywords": ["завтрак", "метаболизм", "ed smart", "коктейль"]
    },
    {
        "text": "Совет: Спи 7-8 часов. Недосып = набор веса + стресс + плохая кожа. Качественный сон — основа здоровья и красоты.",
        "category": "health_tips",
        "keywords": ["сон", "7-8 часов", "вес", "стресс", "здоровье"]
    },
    {
        "text": "Совет: Двигайся минимум 30 минут в день. Прогулка, танцы, уборка — любая активность. Движение = жизнь и хорошее настроение.",
        "category": "health_tips",
        "keywords": ["движение", "активность", "30 минут", "прогулка"]
    },

    # Общие вопросы
    {
        "text": "Как начать с NL? 1) Зарегистрируйся на сайте. 2) Закажи стартовый набор. 3) Попробуй продукты сам. 4) Расскажи друзьям. 5) Пройди обучение. 6) Начинай зарабатывать!",
        "category": "getting_started",
        "keywords": ["как начать", "старт", "регистрация", "стартовый набор"]
    },
    {
        "text": "Сколько можно заработать? Зависит от твоей активности. M1: 20-30 тыс. M2: 40-60 тыс. M3: 80-120 тыс. B1: 150-250 тыс. B2: 300-500 тыс. B3: 600 тыс - 1 млн руб/мес.",
        "category": "getting_started",
        "keywords": ["заработать", "доход", "сколько", "квалификация"]
    },
    {
        "text": "Сколько времени нужно? Зависит от цели. Для M1 — 1-2 месяца по 2-3 часа в день. Для B1 — 6-12 месяцев полноценной работы. Можно быстрее при большой активности.",
        "category": "getting_started",
        "keywords": ["время", "сколько нужно", "месяцы", "активность"]
    },

    # Дополнительные продукты (итого 50+ документов)
    {
        "text": "Slim Effect — жиросжигатель. L-карнитин + зелёный чай + гуарана. Ускоряет расщепление жиров. Принимать перед тренировкой или утром. Без химии.",
        "category": "products",
        "keywords": ["slim effect", "жиросжигатель", "l-карнитин", "похудеть", "тренировка"]
    },
    {
        "text": "Night Repair — ночной восстановитель. Коллаген + мелатонин + магний. Улучшает сон, восстанавливает кожу ночью. Просыпаешься отдохнувшим и свежим.",
        "category": "products",
        "keywords": ["night repair", "сон", "восстановление", "коллаген", "мелатонин"]
    },
    {
        "text": "Joint Support — для суставов и связок. Глюкозамин + хондроитин + коллаген. Уменьшает боль, увеличивает подвижность. Для спортсменов и после 40 лет.",
        "category": "products",
        "keywords": ["joint support", "суставы", "связки", "глюкозамин", "боль"]
    },
    {
        "text": "Probiotic Complex — пробиотики для ЖКТ. 10 млрд живых бактерий. Улучшает пищеварение, иммунитет, настроение. Особенно важно после антибиотиков.",
        "category": "products",
        "keywords": ["probiotic", "пробиотики", "жкт", "пищеварение", "бактерии"]
    },
]


class MockRAGEngine:
    """
    Mock RAG Engine для быстрого тестирования

    Использует keyword search вместо vector embeddings.
    Быстрее чем реальный RAG, не нагружает БД.
    """

    def __init__(self, knowledge_base: List[Dict] = None):
        self.knowledge_base = knowledge_base or MOCK_KNOWLEDGE_BASE
        self.search_count = 0
        self.total_results = 0

    async def retrieve(
        self,
        query: str,
        top_k: int = 5,
        min_similarity: float = 0.45,
        categories: Optional[List[str]] = None
    ) -> List[Dict]:
        """
        Поиск документов по запросу

        Args:
            query: Поисковый запрос
            top_k: Количество результатов
            min_similarity: Минимальная схожесть (0-1)
            categories: Фильтр по категориям

        Returns:
            Список найденных документов с similarity score
        """
        self.search_count += 1
        query_lower = query.lower()
        results = []

        for doc in self.knowledge_base:
            # Фильтруем по категории
            if categories and doc.get("category") not in categories:
                continue

            # Keyword matching
            text_lower = doc["text"].lower()
            keywords = doc.get("keywords", [])

            # Считаем score
            score = 0

            # Проверяем каждое слово из query
            query_words = query_lower.split()
            for word in query_words:
                if len(word) < 3:  # Пропускаем короткие слова
                    continue

                # Проверяем в тексте
                if word in text_lower:
                    score += 2

                # Проверяем в keywords (приоритет)
                if any(word in kw for kw in keywords):
                    score += 3

            # Нормализуем score (0-1)
            max_possible_score = len(query_words) * 5
            normalized_score = min(score / max_possible_score, 1.0) if max_possible_score > 0 else 0

            if normalized_score > 0:
                results.append({
                    "text": doc["text"],
                    "category": doc.get("category", "general"),
                    "similarity": normalized_score,
                    "keywords": keywords,
                })

        # Сортируем по similarity
        results.sort(key=lambda x: x["similarity"], reverse=True)

        # Фильтруем по min_similarity
        results = [r for r in results if r["similarity"] >= min_similarity]

        # Ограничиваем top_k
        results = results[:top_k]

        self.total_results += len(results)

        return results

    async def retrieve_by_category(
        self,
        category: str,
        top_k: int = 10
    ) -> List[Dict]:
        """Возвращает все документы определённой категории"""
        self.search_count += 1

        results = [
            {
                "text": doc["text"],
                "category": doc["category"],
                "keywords": doc.get("keywords", []),
            }
            for doc in self.knowledge_base
            if doc.get("category") == category
        ]

        self.total_results += len(results[:top_k])
        return results[:top_k]

    def get_metrics(self) -> Dict:
        """Возвращает метрики поиска"""
        return {
            "search_count": self.search_count,
            "total_results": self.total_results,
            "avg_results_per_search": self.total_results / self.search_count if self.search_count > 0 else 0,
            "knowledge_base_size": len(self.knowledge_base),
        }

    def reset_metrics(self):
        """Сбрасывает метрики"""
        self.search_count = 0
        self.total_results = 0
