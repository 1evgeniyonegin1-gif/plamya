"""
Обработчик возражений для NL International.
Генерирует ответы от лица Данила на типичные возражения.
"""

import random
import httpx
from .config import DEEPSEEK_API_KEY, DEEPSEEK_BASE_URL


# ── Готовые ответы на возражения (быстро, без API) ──

OBJECTIONS_DB = {
    "пирамида": {
        "short": "NL — 20+ лет на рынке, сертифицированные продукты. В пирамиде деньги за привлечение, в NL — за продажу.",
        "hooks": [
            "Пирамида — это когда деньги берут за вход и нет продукта. В NL регистрация бесплатная, а продукт реально работает.",
            "Каждый раз когда слышу 'пирамида' — хочу спросить: а работа на дядю где ты получаешь 5% от того что приносишь — это что?",
            "Я тоже так думал. Потом увидел как батя выпил DrainEffect и через 30 мин перестал быть жёлтым. Пирамиды так не работают.",
        ],
    },
    "дорого": {
        "short": "186₽ за полноценный приём пищи. Кафе — 300-500₽. Клиентский клуб — скидка без обязательств.",
        "hooks": [
            "186₽ за порцию. Это дешевле чем завтрак в любой столовой. А КБЖУ — как у полноценного обеда.",
            "Дорого — это когда платишь за то что не работает. 186₽ за ED Smart vs 500₽ за кофе с булкой который через час опять голодный.",
            "Можно начать с Клиентского клуба — просто скидка, без обязательств, без бизнеса. Попробуй, потом решишь.",
        ],
    },
    "нет_времени": {
        "short": "30 мин/день. AI автоматизирует 80%. Клиентский клуб — вообще без обязательств.",
        "hooks": [
            "Я строю AI-систему которая делает 80% работы. Серьёзно. Тебе останется только делиться результатами.",
            "Нет времени = не приоритет. Нормально. Но если тратишь 2 часа на сериалы — время есть, просто выбор другой.",
            "Клиентский клуб: покупаешь со скидкой то что итак бы покупал. Времени: 0 минут.",
        ],
    },
    "не_умею_продавать": {
        "short": "Не нужно продавать. Попробуй → расскажи результат. Обучение NBS + AI-куратор помогут.",
        "hooks": [
            "Я тоже не умею. Поэтому построил AI который делает это за меня. Серьёзно.",
            "Продавать не нужно. Расскажи как пил коктейль и как себя чувствовал. Это не продажа — это жизнь.",
            "В NL есть NBS — система обучения. Плюс AI-куратор (@nl_curator_bot) ответит на любой вопрос 24/7.",
        ],
    },
    "сетевой_бизнес_не_работает": {
        "short": "Не работает у тех кто делает как 10 лет назад. AI + автоматизация = другая игра.",
        "hooks": [
            "Классический сетевой — да, сложно. Поэтому я не делаю классически. AI делает 80%, я — стратегию.",
            "То же самое говорили про интернет-магазины. Потом про блоги. Потом про YouTube. Меняется инструмент, не принцип.",
        ],
    },
}


def get_quick_objection_response(objection_key: str) -> str:
    """Быстрый ответ без API-вызова."""
    obj = OBJECTIONS_DB.get(objection_key)
    if not obj:
        return ""
    return random.choice(obj["hooks"])


def detect_objection(text: str) -> str | None:
    """Определяет тип возражения по тексту."""
    text_lower = text.lower()

    patterns = {
        "пирамида": ["пирамид", "мошенни", "обман", "развод", "лохотрон", "секта"],
        "дорого": ["дорого", "цена", "денег нет", "не могу себе позволить", "бюджет"],
        "нет_времени": ["нет времени", "занят", "некогда", "времени нет", "не успеваю"],
        "не_умею_продавать": ["не умею продавать", "продажи не моё", "интроверт", "стесняюсь"],
        "сетевой_бизнес_не_работает": ["не работает", "никто не зарабатывает", "амвей", "гербалайф"],
    }

    for key, keywords in patterns.items():
        for kw in keywords:
            if kw in text_lower:
                return key
    return None


async def generate_objection_post(objection_key: str, segment: str = "business") -> str:
    """Генерирует пост-ответ на возражение через Deepseek."""
    obj = OBJECTIONS_DB.get(objection_key, {})
    short_answer = obj.get("short", "")

    segment_tone = {
        "zozh": "Экспертный тон, факты о продуктах, здоровье",
        "mama": "Тёплый тон, без мата, забота о семье",
        "business": "Деловой-неформальный, цифры и факты",
        "student": "Свой стиль, мат ОК, юмор, без корпоративного BS",
    }

    prompt = f"""Напиши пост для Telegram (200-500 символов) от лица Данила.
Тема: ответ на возражение "{objection_key.replace('_', ' ')}".
Суть ответа: {short_answer}
Тон: {segment_tone.get(segment, segment_tone['business'])}

Правила:
- От первого лица (я = Данил, 21 год, после армии, строю AI для NL)
- Не менторский тон, а "вот как я это вижу"
- Без хештегов
- Без AI-слов ("безусловно", "стоит отметить", "трансформация")
- Реальные примеры: ED Smart 186₽/порция, DrainEffect результат за 30 мин
"""

    try:
        async with httpx.AsyncClient(timeout=60) as client:
            response = await client.post(
                f"{DEEPSEEK_BASE_URL}/chat/completions",
                headers={
                    "Authorization": f"Bearer {DEEPSEEK_API_KEY}",
                    "Content-Type": "application/json",
                },
                json={
                    "model": "deepseek-chat",
                    "messages": [{"role": "user", "content": prompt}],
                    "temperature": 0.85,
                    "max_tokens": 800,
                },
            )
            response.raise_for_status()
            data = response.json()
            return data["choices"][0]["message"]["content"].strip()
    except Exception as e:
        return f"[Ошибка: {e}]. Быстрый ответ: {short_answer}"
